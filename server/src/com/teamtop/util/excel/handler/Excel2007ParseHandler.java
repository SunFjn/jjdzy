package com.teamtop.util.excel.handler;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;

import org.xml.sax.Attributes;
import org.xml.sax.SAXException;
import org.xml.sax.helpers.DefaultHandler;

import com.teamtop.util.excel.ExcelReaderUtil;
import com.teamtop.util.excel.ExcelWrite;
import com.teamtop.util.excel.cache.WorkBookCache;
/**
 * 读取sheet1，其实读取的是xl/worksheets/sheet1.xml文件
 * 该文件格式为<row r="1" spans="1:13"><c r="A1" s="4" t="s"><v>0</v></c></row>
 * r="1"表示为第一行，行数从1开始；t="s"表示该元素为字符串，值存在于sharedStrings.xml中，
 * <v></v>标签中的数字为sharedString.xml顺序读下来的索引。
 * <c></c>元素之间或许无子元素。
 * @author wujabon
 *
 */
public class Excel2007ParseHandler extends DefaultHandler {
	//是否需要用当前的value替换成sharedString.xml里面的数据
	private List<String> dataList;
	//保存当前已读过的行序号，用于是判断否往下读
	private int index;
	//标识是否需要替换字符串
	private boolean isReplaceData;
	//不需要替换字符串的时候，是为了防止因过长或者其他原因导致读取不全
	private StringBuilder appendStr;
	//是否继续往下读取，设置该字段最主要防止excel表写完后下面隔了很多行再有写入的垃圾数据
	private boolean isContinue;
	//上次读取的列序号
	private int preColNum;
	//当前列序号
	private int curColNum;
	//最大的列序号
	private int maxColNum;
	//excel文件名称
	private String fileName;
	//当前标签名
	private String nowTarget;
	//整个文档的数据
	private HashMap<String,Object[]> excelDataMap;
	//整个文档的信息部分（文档前三行）
	private String[] typeArr;
	private String[] fieldArr;
	private String[] commonArr;
	//用于生成代码的此excel的名字:map equip levle...
	private String excelName = "";
	//标识是否第一行
	private boolean isRowOne;
	//共享字符串数据
	private List<String> sharedString;
	//第一个元素的数据
	private String firstElement;
	//不需要读取的列
	private List<Integer> notReadCol;
	//用于判断该表需不需要读
	private boolean isNeedRead;
	//是否需要读取该行
	private boolean isNeedReadRow;
	private int rowNum;

	/**
	 * 初始化文件名
	 * @param fileName
	 */
	public Excel2007ParseHandler(String fileName) {
		this.fileName = fileName;
	}

	/**
	 * 开始读取文档，初始化数据，除文件名外的其他字段大部分都在此初始化
	 */
	@Override
	public void startDocument() throws SAXException {
		index = 0;
		isReplaceData = false;
		appendStr = new StringBuilder();
		isContinue = true;
		sharedString = WorkBookCache.getSharedStringWork(fileName);
		excelDataMap = new HashMap<String,Object[]>();
		notReadCol = new ArrayList<Integer>();
		isNeedRead = true;
		isNeedReadRow = true;
		rowNum =0;
	}
	
	/**
	 * 开始读取某个元素
	 * 注：第一个元素的设置空值或初始化将由该方法执行，endElement方法中操作或许读取会有问题，列数的操作也由该方法操作
	 */
	@Override
	public void startElement(String uri, String localName, String qName,
			Attributes attributes) throws SAXException {
		nowTarget = qName;
		if(!isNeedRead) return;
		//一行开始读取的时候
		if("row".equals(qName)) {
			firstElement = null;
			int rowIndex = Integer.parseInt(attributes.getValue("r"));
			preColNum = 0;
			curColNum = 0;
			if(rowIndex == 1) {
				isRowOne = true;
				//return;
			}
			rowNum = rowIndex;
			
			if(rowIndex > ExcelReaderUtil.IGNORE_ROW) {
				isContinue = Integer.parseInt(attributes.getValue("r")) <= index+5;
				//如果下一行与上一行相隔5行左右 则没必要读下去，因为有可能是误写入的操作 比如很下面的地方多了一个点
				if(!isContinue) {
					return;
				}
				index = rowIndex;
				dataList = new ArrayList<String>();
			}
			return;
		}
		//一列开始读取
		if("c".equals(qName)) {
			String colNum = attributes.getValue("r");
			preColNum = curColNum;
			curColNum = 0;
			int len = colNum.length();
			for(int i = 0; i < len; i ++) {
				//列号
				int nowCol = colNum.charAt(i);
				//System.err.println(nowCol);
				if(nowCol >= 65 && nowCol <= 90){
					curColNum *= 26;
					curColNum += nowCol - 64;
				}else{
					break;
				}
			}
			//如果是第一行
			if(isRowOne && preColNum + 1 != curColNum) {
				curColNum = preColNum;
			}
			appendStr.delete(0, appendStr.length());
			if(notReadCol.contains(curColNum)) return;
			if(!isNeedReadRow) return;
			//是否需要替换文档数据
			isReplaceData = "s".equals(attributes.getValue("t"));
			
			//如果上一列的列号与这一列相隔大于1个，则添加空串
			if(preColNum + 1 < curColNum && dataList != null) {
				int targetNum = curColNum <= maxColNum ? curColNum : maxColNum;
//				System.out.println(curColNum + "  " + preColNum);
				for(int i = preColNum + 1; i < targetNum; i ++) {
					dataList.add("");
				}
 			}
		}
	}
	
	/**
	 * 元素结束
	 */
	@Override
	public void endElement(String uri, String localName, String qName)
			throws SAXException {
		if(!isContinue) return;
		if(!isNeedRead) return;
		this.nowTarget = null;
		//一行读取结束
		if("row".equals(qName)) {
			if(isRowOne) {
				maxColNum = curColNum;
				isRowOne = false;
				//return;
			}
			if(!isNeedReadRow){
				isNeedReadRow = true;
				return;
			}
			
			//如果第一个列的元素为空 则不保存
			if(firstElement == null || "".equals(firstElement.trim()) || "".equals(dataList.get(0).trim())){
				dataList = null;
				return;
			}
			if(rowNum > ExcelReaderUtil.INFO_ROW) {
				excelDataMap.put(dataList.get(1), dataList.toArray());
			}else {
				if(rowNum==2){
					typeArr = new String[dataList.size()];
					dataList.toArray(typeArr);
				}else if(rowNum==3){
					fieldArr = new String[dataList.size()];
					dataList.toArray(fieldArr);
					excelName = fieldArr[0];
				}else if(rowNum==4){
					commonArr = new String[dataList.size()];
					dataList.toArray(commonArr);
				}
			}
			dataList = null;
			return;
		}
		if(!isNeedReadRow) return;
		//一列读取结束
		if("c".equals(qName)) {
			//如果包含了该列无需读取，则跳过
			if(notReadCol.contains(curColNum)) return;
			//String data = ExcelReaderUtil.isNum(appendStr.toString());
			//不再转换成float
			String data = appendStr.toString();
			//第一列
			if(curColNum == 1 && appendStr.length() != 0) {
				firstElement = data;
			}else if(curColNum == 1 && dataList!= null && !dataList.isEmpty()){
				firstElement = dataList.get(0);
			}
			//正文
			//if(curColNum != 1 /*&& !isRowOne*/) {
				if(curColNum <= maxColNum && dataList!=null && !isReplaceData){
					dataList.add(data);
				}
			//}
			//判断是否需要读取
			if(rowNum == 2) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
				/*if(curColNum == 1 && !("DOUBLE".equals(data.trim()) ||"SERVER".equals(data.trim()))){
					isNeedRead = true;
				}else if(data.endsWith(".C")){
					notReadCol.add(curColNum);
				}*/
				int len = dataList.size() - 1;
				if("NO".equals(dataList.get(len))) {
					notReadCol.add(curColNum);
//					dataList.get(dataList.size() )
					dataList.remove(len);
				}
			}else {
				//1表示是后端需要读取的数据
				if(curColNum == 1 && !/*"1.0".equals(data.trim()) || */"1".equals(data.trim())) {
					//isNeedReadRow = false;
				}
			}
			
			isReplaceData = false;
		}
	}
	
	/**
	 * 读取value值
	 */
	@Override
	public void characters(char[] ch, int start, int length)
			throws SAXException {
		//不再继续往下读
		if(!isContinue) return;
		//如果不是第一行 则需要判断是否超出最大列
		if(!isRowOne && curColNum > maxColNum) return;
		//是否需要读，如果文档中标识不需要读该表 则挑过
		if(!isNeedRead) return;
		//如果文档中表示不需要读取该行，挑过
		if(!isNeedReadRow) return;
		//第一行单独处理
		/*if(isRowOne) {
			String wb = sharedString.get(Integer.parseInt(new String(ch, start, length)));
			if(wb == null) {
				System.err.println("Error!!! In cache no it!!!");
				return;
			}
			//appendStr.append(wb);
			dataList.add(wb);
			return;
		}*/
		
		//第一列有可能保存的是一个字符串
		/*if(curColNum == 1 && rowNum > ExcelReaderUtil.INFO_ROW) {
			if(isReplaceData) {
				String wb = sharedString.get(Integer.parseInt(new String(ch, start, length)));
				if(wb == null) {
					System.err.println("Error!!! In cache no it!!!");
					return;
				}
				appendStr.append(wb);
			}else{
				appendStr.append(new String(ch, start, length));
			}
			return;
		}*/
		//需要替换成共享字符串
		if("v".equals(nowTarget) && isReplaceData && dataList!=null ) {
			if(rowNum <= ExcelReaderUtil.INFO_ROW || curColNum != 1){
				String wb = sharedString.get(Integer.parseInt(new String(ch, start, length)));
				if(wb == null) {
					System.err.println("Error!!! In cache no it!!!");
					return;
				}
				dataList.add(wb);
			}
		} else if("v".equals(nowTarget) && dataList != null) {//无需替换
			appendStr.append(new String(ch, start, length));
			//System.out.println(1);
		}
	}
	
	/**
	 * 读取文档完毕，存档
	 */
	@Override
	public void endDocument() throws SAXException {
		if(!isNeedRead) {
			return;
		}
		WorkBookCache.allDataCache.put(fileName, excelDataMap);
//		WorkBookCache.excelMap.put(fileName, infoDataMap);
		ExcelWrite.transTypeArr(typeArr);
		ExcelWrite.writeStructClass(fileName,excelName,typeArr,fieldArr,commonArr);
		ExcelWrite.writeConfigClass(excelName, typeArr,excelDataMap);
//		write();
		
	}
	
	/**
	 * 仅测试使用
	 *//*
	public void write() {
		File file = new File("E:\\输出路径\\" + fileName + ".txt");
		if(!file.exists()){
			try {
				file.createNewFile();
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
		try {
			FileOutputStream out = new FileOutputStream(file);
			//int i = 0;
			String str;
			for(Object wb : infoDataMap.values()) {
				str =Arrays.toString((Object[])wb);
				byte [] b = str.getBytes();
				out.write(b);
				out.write("\n".getBytes());
				out.flush();
			}
			out.close();
		} catch (FileNotFoundException e) {
			e.printStackTrace();
		} catch (IOException e) {
			e.printStackTrace();
		}
	}*/
}
